//
//  CategoriesPresenter.swift
//  Myfinan
//
//  Created tambanco ü•≥ on 21.03.2022.
//
//  Template generated by Tambanco
//

import Foundation
import UIKit
import CoreData

// MARK: Output protocol
protocol CategoriesViewProtocol: AnyObject {
    func setCategories(categories: [Category], categoryName: String?)
    func configureAddButton(addButton: UIBarButtonItem)
    func present(viewControllerToPresent: UIViewController)
}

// MARK: Input protocol
protocol CategoriesPresenterProtocol: AnyObject {
    init(view: CategoriesViewProtocol, categories:  [Category])
    func showCategories()
    func showAddButton()
    func editModel(indexPath: IndexPath)
    func removeModelItems(indexPath: IndexPath)
}

class CategoriesPresenter: CategoriesPresenterProtocol {
    
    var categories: [Category] = [Category]()
    weak var view: CategoriesViewProtocol?
    let context = CoreDataManager.sharedManager.persistentContainer.viewContext
    
    
    func showAddButton() {
        let addItem = UIBarButtonItem(barButtonSystemItem: .add, target: self, action: #selector(addCategory))
        self.view?.configureAddButton(addButton: addItem)
    }
    
    @objc func addCategory() {
        let alert = UIAlertController(title: "–î–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é", message: "", preferredStyle: .alert)
        alert.addTextField { alertTextField in
            alertTextField.placeholder = "–í–≤–µ–¥–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é"
            alertTextField.autocapitalizationType = .sentences
        }

        let addAction = UIAlertAction(title: "–î–æ–±–∞–≤–∏—Ç—å", style: .default) { action in
            let newCategory = Category(context: self.context)
            newCategory.name = alert.textFields?.first?.text ?? "999"
            self.categories.append(newCategory)
            self.view?.setCategories(categories: self.categories, categoryName: newCategory.name)
            CoreDataManager.sharedManager.saveContext()
        }

        let cancelAction = UIAlertAction(title: "–û—Ç–º–µ–Ω–∞", style: .cancel, handler: nil)

        alert.addAction(cancelAction)
        alert.addAction(addAction)
        self.view?.present(viewControllerToPresent: alert)
    }
    
    func editModel(indexPath: IndexPath) {
        let alert = UIAlertController(title: "", message: "", preferredStyle: .alert)
        alert.addTextField { alertTextField in
            alertTextField.text = self.categories[indexPath.row].name
            alertTextField.autocapitalizationType = .sentences
        }
        
        let addAction = UIAlertAction(title: "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å", style: .default) { action in
            let updatedValue = alert.textFields?.first?.text ?? "222"
            self.categories[indexPath.row].name = updatedValue
            self.view?.setCategories(categories: self.categories, categoryName: updatedValue)
            self.context.name = updatedValue
            CoreDataManager.sharedManager.saveContext()
            
        }
        
        let cancelAction = UIAlertAction(title: "–û—Ç–º–µ–Ω–∞", style: .cancel, handler: nil)
        
        alert.addAction(cancelAction)
        alert.addAction(addAction)
        self.view?.present(viewControllerToPresent: alert)
    }
    
    func removeModelItems(indexPath: IndexPath) {
        context.delete(categories[indexPath.row])
        do {
            try context.save()
        } catch {
            print("Error saving context \(error.localizedDescription)")
        }
        categories.remove(at: indexPath.row)
        self.view?.setCategories(categories: categories, categoryName: "")
    }
    
    func showCategories() {
        let request: NSFetchRequest<Category> = Category.fetchRequest()
            do {
                categories = try context.fetch(request)
            } catch {
                print("Error fetching request \(error.localizedDescription)")
            }
        self.view?.setCategories(categories: categories, categoryName: "")
    }
    
    required init(view: CategoriesViewProtocol, categories: [Category]) {
        self.view = view
        self.categories = categories
    }
}
